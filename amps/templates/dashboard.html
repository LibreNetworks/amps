<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Amps Control Panel</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { background: #111827; border-color: #1f2937; }
    .table thead th { border-color: #1f2937; }
    .table tbody td { border-color: #1f2937; }
    .form-control, .form-select, .form-check-input { background: #0b1120; border-color: #1f2937; color: #e2e8f0; }
    .form-control:focus, .form-select:focus { border-color: #38bdf8; box-shadow: 0 0 0 0.2rem rgba(56, 189, 248, 0.25); }
    .navbar { background: #0b1120; }
    .badge-soft { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
    a { color: #38bdf8; }
    a:hover { color: #7dd3fc; }
    textarea { min-height: 120px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand fw-semibold">âš¡ Amps Dashboard</span>
    <span class="badge rounded-pill text-bg-primary">Flask</span>
  </div>
</nav>

<div class="container pb-4">
  <div class="row g-4 mb-3">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <h2 class="h4 mb-1">Control your streams</h2>
              <p class="mb-0 text-secondary">Manage playlists, endpoints, EPG feeds, and FFmpeg profiles through a friendly UI.</p>
            </div>
            <span class="badge badge-soft rounded-pill">Bootstrap 5</span>
          </div>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <p class="text-secondary mb-1">Playlist</p>
                  <a href="{{ quick_links.playlist }}" class="stretched-link text-decoration-none">{{ quick_links.playlist }}</a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <p class="text-secondary mb-1">EPG</p>
                  <a href="{{ quick_links.epg }}" class="stretched-link text-decoration-none">{{ quick_links.epg }}</a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <p class="text-secondary mb-1">Metrics</p>
                  <a href="{{ quick_links.metrics }}" class="stretched-link text-decoration-none">{{ quick_links.metrics }}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">Filters</h2>
            <span class="badge rounded-pill text-bg-dark">Auth {{ 'on' if auth_enabled else 'off' }}</span>
          </div>
          <div class="mb-3">
            <label class="form-label">Auth token</label>
            <input type="text" class="form-control" id="token-input" value="{{ token or '' }}" placeholder="Add ?token=... to the URL">
            <div class="form-text">The UI will reuse this token for API calls when authentication is enabled.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Region filter</label>
            <input type="text" class="form-control" id="region-input" value="{{ region or '' }}" placeholder="US, GB, ...">
            <div class="form-text">Applied to playlist links and API filters.</div>
          </div>
          <button class="btn btn-primary w-100" id="refresh-links">Refresh links</button>
        </div>
      </div>
    </div>
  </div>

  <div id="alert-placeholder"></div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h5 mb-0">Streams</h2>
        <span class="text-secondary">{{ streams|length }} configured</span>
      </div>
      <div class="table-responsive">
        <table class="table table-dark align-middle mb-0" id="streams-table">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Name</th>
              <th scope="col">Profile</th>
              <th scope="col">Source</th>
              <th scope="col">Group</th>
              <th scope="col">Regions</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for stream in streams %}
            <tr data-stream='{{ stream | tojson | safe }}'>
              <th scope="row">{{ stream.id }}</th>
              <td>
                <div class="fw-semibold">{{ stream.name }}</div>
                {% if stream.logo %}<div class="text-secondary small">{{ stream.logo }}</div>{% endif %}
              </td>
              <td>{{ stream.ffmpeg_profile or 'Custom' }}</td>
              <td class="text-truncate" style="max-width: 260px">{{ stream.source or 'Custom FFmpeg' }}</td>
              <td>{{ stream.group or '-' }}</td>
              <td class="text-secondary small">{{ (stream.regions_allowed or [])|join(', ') }}{% if stream.regions_blocked %} | blocked: {{ stream.regions_blocked|join(', ') }}{% endif %}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-info me-2 load-stream">Load</button>
                <button class="btn btn-sm btn-outline-danger delete-stream">Delete</button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-secondary">No streams configured yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h5 mb-0">Add or update a stream</h2>
        <button class="btn btn-outline-light btn-sm" id="clear-form">Clear form</button>
      </div>
      <form id="stream-form">
        <div class="row g-3 mb-3">
          <div class="col-md-2">
            <label class="form-label">Stream ID (for updates)</label>
            <input type="number" class="form-control" id="stream-id" placeholder="Auto">
          </div>
          <div class="col-md-5">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="stream-name" required>
          </div>
          <div class="col-md-5">
            <label class="form-label">Source URL</label>
            <input type="text" class="form-control" id="stream-source" placeholder="rtmp:// or https://">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">FFmpeg profile</label>
            <select class="form-select" id="ffmpeg-profile">
              <option value="">-- Select profile (or leave blank for custom) --</option>
              {% for profile in ffmpeg_profiles.keys() %}
              <option value="{{ profile }}">{{ profile }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Group</label>
            <input type="text" class="form-control" id="stream-group" placeholder="News, Sports, ...">
          </div>
          <div class="col-md-4">
            <label class="form-label">Channel number</label>
            <input type="number" class="form-control" id="channel-number" min="1">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Logo URL</label>
            <input type="text" class="form-control" id="logo-url" placeholder="https://.../logo.png">
          </div>
          <div class="col-md-6">
            <label class="form-label">TVG name</label>
            <input type="text" class="form-control" id="tvg-name" placeholder="For playlist metadata">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Program feed URL</label>
            <input type="text" class="form-control" id="program-feed" placeholder="External program feed link">
          </div>
          <div class="col-md-6">
            <label class="form-label">Description</label>
            <input type="text" class="form-control" id="description" placeholder="Channel description">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Regions allowed (comma separated)</label>
            <input type="text" class="form-control" id="regions-allowed" placeholder="US,CA">
          </div>
          <div class="col-md-6">
            <label class="form-label">Regions blocked (comma separated)</label>
            <input type="text" class="form-control" id="regions-blocked" placeholder="RU,CN">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Custom FFmpeg (JSON string or object)</label>
            <textarea class="form-control" id="custom-ffmpeg" placeholder='{"command": "ffmpeg ..."}'></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Adaptive bitrates (JSON array)</label>
            <textarea class="form-control" id="adaptive-bitrates" placeholder='[{"name": "low", "ffmpeg_profile": "360p"}]'></textarea>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Input options (JSON object)</label>
            <textarea class="form-control" id="input-options" placeholder='{"rtsp_transport": "tcp"}'></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Input args (JSON array)</label>
            <textarea class="form-control" id="input-args" placeholder='["-re", "-itsoffset", "0.5"]'></textarea>
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Source handler (JSON object)</label>
            <textarea class="form-control" id="source-handler" placeholder='{"type": "yt_dlp", "format": "best"}'></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Next programs (JSON array)</label>
            <textarea class="form-control" id="next-programs" placeholder='[{"title": "Show", "start": "2024-05-08T18:00:00Z"}]'></textarea>
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" type="checkbox" role="switch" id="use-yt-dlp">
              <label class="form-check-label" for="use-yt-dlp">Use yt-dlp</label>
            </div>
          </div>
          <div class="col-md-8">
            <label class="form-label">yt-dlp format</label>
            <input type="text" class="form-control" id="yt-dlp-format" placeholder="bestvideo+bestaudio/best">
          </div>
        </div>
        <div class="d-flex gap-3">
          <button type="submit" class="btn btn-primary" data-action="create">Create stream</button>
          <button type="submit" class="btn btn-success" data-action="update">Update stream</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h2 class="h5">How links are built</h2>
      <p class="text-secondary mb-2">Playlist, stream, and EPG links reuse the token and region filters shown at the top. Copy the links directly or paste them into your player.</p>
      <ul class="mb-0 text-secondary">
        <li>Streams play via <code>/stream/&lt;id&gt;</code> and optional <code>?variant=&lt;name&gt;</code>.</li>
        <li>HLS manifests live at <code>/hls/&lt;id&gt;/index.m3u8</code> and DASH at <code>/dash/&lt;id&gt;/manifest.mpd</code>.</li>
        <li>EPG JSON is under <code>/api/epg</code> and XMLTV at <code>/epg.xml</code>.</li>
      </ul>
    </div>
  </div>
</div>

<script>
  const authEnabled = {{ 'true' if auth_enabled else 'false' }};
  const initialToken = {{ (token or '') | tojson }};
  const initialRegion = {{ (region or '') | tojson }};

  const alertPlaceholder = document.getElementById('alert-placeholder');
  const streamForm = document.getElementById('stream-form');
  const tokenInput = document.getElementById('token-input');
  const regionInput = document.getElementById('region-input');
  const refreshLinksBtn = document.getElementById('refresh-links');

  function showAlert(message, type = 'success') {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    alertPlaceholder.innerHTML = '';
    alertPlaceholder.append(wrapper);
  }

  function parseJsonField(value, fieldName) {
    const trimmed = value.trim();
    if (!trimmed) return undefined;
    try {
      return JSON.parse(trimmed);
    } catch (err) {
      showAlert(`${fieldName} must be valid JSON: ${err.message}`, 'danger');
      throw err;
    }
  }

  function parseList(value) {
    const trimmed = value.trim();
    if (!trimmed) return undefined;
    return trimmed.split(',').map(v => v.trim()).filter(Boolean);
  }

  function parseInteger(value) {
    if (!value) return undefined;
    const parsed = parseInt(value, 10);
    return Number.isFinite(parsed) ? parsed : undefined;
  }

  function apiUrl(path) {
    const url = new URL(path, window.location.origin);
    if (authEnabled && tokenInput.value) url.searchParams.set('token', tokenInput.value);
    if (regionInput.value) url.searchParams.set('region', regionInput.value.trim());
    return url;
  }

  function apiRequest(path, options = {}) {
    const url = apiUrl(path);
    const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
    if (authEnabled && tokenInput.value) {
      headers['X-Amps-Token'] = tokenInput.value;
    }
    return fetch(url, { ...options, headers });
  }

  function fillForm(stream) {
    document.getElementById('stream-id').value = stream.id || '';
    document.getElementById('stream-name').value = stream.name || '';
    document.getElementById('stream-source').value = stream.source || '';
    document.getElementById('ffmpeg-profile').value = stream.ffmpeg_profile || '';
    document.getElementById('stream-group').value = stream.group || '';
    document.getElementById('channel-number').value = stream.channel_number || '';
    document.getElementById('logo-url').value = stream.logo || '';
    document.getElementById('tvg-name').value = stream.tvg_name || '';
    document.getElementById('program-feed').value = stream.program_feed || '';
    document.getElementById('description').value = stream.description || '';
    document.getElementById('regions-allowed').value = (stream.regions_allowed || []).join(', ');
    document.getElementById('regions-blocked').value = (stream.regions_blocked || []).join(', ');
    document.getElementById('custom-ffmpeg').value = stream.custom_ffmpeg ? JSON.stringify(stream.custom_ffmpeg, null, 2) : '';
    document.getElementById('adaptive-bitrates').value = stream.adaptive_bitrates ? JSON.stringify(stream.adaptive_bitrates, null, 2) : '';
    document.getElementById('input-options').value = stream.input_options ? JSON.stringify(stream.input_options, null, 2) : '';
    document.getElementById('input-args').value = stream.input_args ? JSON.stringify(stream.input_args, null, 2) : '';
    document.getElementById('source-handler').value = stream.source_handler ? JSON.stringify(stream.source_handler, null, 2) : '';
    document.getElementById('next-programs').value = stream.next_programs ? JSON.stringify(stream.next_programs, null, 2) : '';
    document.getElementById('use-yt-dlp').checked = !!stream.use_yt_dlp;
    document.getElementById('yt-dlp-format').value = stream.yt_dlp_format || '';
  }

  function resetForm() {
    streamForm.reset();
    document.getElementById('custom-ffmpeg').value = '';
    document.getElementById('adaptive-bitrates').value = '';
    document.getElementById('input-options').value = '';
    document.getElementById('input-args').value = '';
    document.getElementById('source-handler').value = '';
    document.getElementById('next-programs').value = '';
  }

  function collectPayload() {
    const payload = {};
    payload.name = document.getElementById('stream-name').value.trim();
    payload.source = document.getElementById('stream-source').value.trim();
    payload.ffmpeg_profile = document.getElementById('ffmpeg-profile').value || undefined;
    payload.group = document.getElementById('stream-group').value.trim() || undefined;
    payload.channel_number = parseInteger(document.getElementById('channel-number').value);
    payload.logo = document.getElementById('logo-url').value.trim() || undefined;
    payload.tvg_name = document.getElementById('tvg-name').value.trim() || undefined;
    payload.program_feed = document.getElementById('program-feed').value.trim() || undefined;
    payload.description = document.getElementById('description').value.trim() || undefined;
    payload.regions_allowed = parseList(document.getElementById('regions-allowed').value);
    payload.regions_blocked = parseList(document.getElementById('regions-blocked').value);
    payload.custom_ffmpeg = parseJsonField(document.getElementById('custom-ffmpeg').value, 'Custom FFmpeg');
    payload.adaptive_bitrates = parseJsonField(document.getElementById('adaptive-bitrates').value, 'Adaptive bitrates');
    payload.input_options = parseJsonField(document.getElementById('input-options').value, 'Input options');
    payload.input_args = parseJsonField(document.getElementById('input-args').value, 'Input args');
    payload.source_handler = parseJsonField(document.getElementById('source-handler').value, 'Source handler');
    payload.next_programs = parseJsonField(document.getElementById('next-programs').value, 'Next programs');
    payload.use_yt_dlp = document.getElementById('use-yt-dlp').checked;
    payload.yt_dlp_format = document.getElementById('yt-dlp-format').value.trim() || undefined;

    Object.keys(payload).forEach(key => {
      if (payload[key] === undefined || payload[key] === '') {
        delete payload[key];
      }
    });

    return payload;
  }

  streamForm.addEventListener('submit', (event) => {
    event.preventDefault();
    const action = event.submitter?.dataset?.action;
    const streamId = document.getElementById('stream-id').value;
    const payload = collectPayload();

    if (!payload.name) {
      showAlert('A stream name is required.', 'danger');
      return;
    }

    if (!payload.source && !payload.custom_ffmpeg) {
      showAlert('Provide a source URL or a custom FFmpeg command.', 'danger');
      return;
    }

    if (!payload.ffmpeg_profile && !payload.custom_ffmpeg) {
      showAlert('Select an ffmpeg_profile or provide a custom_ffmpeg command.', 'danger');
      return;
    }

    if (action === 'update') {
      if (!streamId) {
        showAlert('Select a stream to update by loading it from the table.', 'danger');
        return;
      }
      apiRequest(`/api/streams/${streamId}`, { method: 'PUT', body: JSON.stringify(payload) })
        .then(resp => resp.json().then(data => ({ status: resp.status, data })))
        .then(({ status, data }) => {
          if (status >= 200 && status < 300) {
            showAlert(`Updated stream ${data.name || streamId}.`);
            setTimeout(() => window.location.reload(), 500);
          } else {
            showAlert(data.error || 'Failed to update stream.', 'danger');
          }
        })
        .catch(err => showAlert(err.message, 'danger'));
      return;
    }

    apiRequest('/api/streams', { method: 'POST', body: JSON.stringify(payload) })
      .then(resp => resp.json().then(data => ({ status: resp.status, data })))
      .then(({ status, data }) => {
        if (status >= 200 && status < 300) {
          showAlert(`Created stream ${data.name} (ID ${data.id}).`);
          setTimeout(() => window.location.reload(), 500);
        } else {
          showAlert(data.error || 'Failed to create stream.', 'danger');
        }
      })
      .catch(err => showAlert(err.message, 'danger'));
  });

  document.querySelectorAll('#streams-table .load-stream').forEach(btn => {
    btn.addEventListener('click', (event) => {
      const row = event.target.closest('tr');
      const stream = JSON.parse(row.dataset.stream);
      fillForm(stream);
      showAlert(`Loaded stream ${stream.name} into the form.`, 'info');
    });
  });

  document.querySelectorAll('#streams-table .delete-stream').forEach(btn => {
    btn.addEventListener('click', (event) => {
      const row = event.target.closest('tr');
      const stream = JSON.parse(row.dataset.stream);
      if (!confirm(`Delete stream ${stream.name} (ID ${stream.id})?`)) return;
      apiRequest(`/api/streams/${stream.id}`, { method: 'DELETE' })
        .then(resp => resp.json().then(data => ({ status: resp.status, data })))
        .then(({ status, data }) => {
          if (status >= 200 && status < 300) {
            showAlert(`Deleted stream ${stream.name}.`);
            setTimeout(() => window.location.reload(), 400);
          } else {
            showAlert(data.error || 'Failed to delete stream.', 'danger');
          }
        })
        .catch(err => showAlert(err.message, 'danger'));
    });
  });

  document.getElementById('clear-form').addEventListener('click', (event) => {
    event.preventDefault();
    resetForm();
  });

  refreshLinksBtn.addEventListener('click', () => {
    const current = new URL(window.location.href);
    if (tokenInput.value) {
      current.searchParams.set('token', tokenInput.value);
    } else {
      current.searchParams.delete('token');
    }
    if (regionInput.value) {
      current.searchParams.set('region', regionInput.value.trim());
    } else {
      current.searchParams.delete('region');
    }
    window.location.href = current.toString();
  });

  if (authEnabled && !tokenInput.value) {
    showAlert('Authentication is enabled. Add your token in the Filters panel to use the UI.', 'warning');
  }

  tokenInput.value = initialToken;
  regionInput.value = initialRegion;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
